<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raporty - Hook Boost Web</title>
    <link rel="stylesheet" href="/static/css/app.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <img src="/static/logo.png" alt="HOOK BOOST" class="logo" />
            </h1>
        </div>
        
        <!-- Powrót do strony głównej -->
        <div style="margin-bottom: 30px;">
            <a href="/" class="btn btn-secondary">← Powrót do strony głównej</a>
        </div>
        
        <!-- Lista kategorii -->
        <div class="card">
            <div class="card-header">
                <h2>📊 Dostępne Raporty</h2>
                <p>Wybierz kategorię, aby zobaczyć analizę trendów</p>
                <button onclick="toggleReportsSection()" class="btn btn-toggle">▼</button>
            </div>
            
            <div id="reportsSection" class="reports-section">
                <!-- Lista raportów CSV -->
                <div class="reports-list-section">
                    <div class="section-header">
                        <h3>📁 Raporty CSV</h3>
                        <button onclick="loadReports()" class="btn btn-refresh">🔄 Odśwież Listę</button>
                    </div>
                    <div id="reportsList" class="reports-list">
                        <div class="loading">Ładowanie raportów...</div>
                    </div>
                </div>
                
                <!-- Lista kategorii -->
                <div class="categories-section">
                    <h3>📊 Kategorie</h3>
                    <div id="categoriesList" class="categories-list">
                        <!-- Kategorie będą ładowane dynamicznie -->
                        <div class="loading">Ładowanie kategorii...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api/v1';
        
        // Funkcja do wymuszenia generowania raportu
        async function forceReport(categoryName) {
            if (!confirm(`Czy na pewno chcesz wymusić generowanie raportu dla kategorii "${categoryName}"?\n\nTo może zająć kilka minut i zużyć quota YouTube API.`)) {
                return;
            }
            
            try {
                // Pokaż status ładowania
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = '⏳ Generuję...';
                button.disabled = true;
                
                const response = await fetch(`/api/v1/force-report/${categoryName}`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(`✅ Raport został wygenerowany pomyślnie!\n\n📊 Filmy: ${result.videos_count}\n📺 Kanały: ${result.channels_count}\n📁 Plik: ${result.csv_path}\n\nRanking zostanie automatycznie zaktualizowany.`);
                    
                    // Odśwież stronę po 2 sekundach
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    alert(`❌ Błąd: ${result.detail}`);
                }
                
            } catch (error) {
                alert(`❌ Błąd połączenia: ${error.message}`);
            } finally {
                // Przywróć oryginalny tekst przycisku
                const button = event.target;
                button.textContent = originalText;
                button.disabled = false;
            }
        }
        
        // Funkcja do regeneracji rankingu
        async function forceRanking(categoryName) {
            if (!confirm(`Czy na pewno chcesz zregenerować ranking dla kategorii "${categoryName}"?\n\nTo użyje najnowszych danych CSV i nowej logiki klasyfikacji (10 min zamiast 3 min).`)) {
                return;
            }
            
            try {
                // Pokaż status ładowania
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = '⏳ Regeneruję...';
                button.disabled = true;
                
                const response = await fetch(`/api/v1/force-ranking/${categoryName}`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(`✅ Ranking został zregenerowany pomyślnie!\n\n📊 Filmy: ${result.videos_count}\n📱 Shorts: ${result.shorts_count}\n🎬 Long-form: ${result.longform_count}\n\n${result.note}\n\nOdśwież stronę, aby zobaczyć nowy ranking.`);
                    
                    // Odśwież stronę po 2 sekundach
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    alert(`❌ Błąd: ${result.detail}`);
                }
                
            } catch (error) {
                alert(`❌ Błąd połączenia: ${error.message}`);
            } finally {
                // Przywróć oryginalny tekst przycisku
                const button = event.target;
                button.textContent = originalText;
                button.disabled = false;
            }
        }
        
        // Funkcja do ładowania kategorii
        async function loadCategories() {
            try {
                const response = await fetch(`${API_BASE}/categories`);
                const categories = await response.json();
                
                let html = '';
                if (categories.length === 0) {
                    html = '<p>Brak dostępnych kategorii</p>';
                } else {
                    categories.forEach(category => {
                        html += `
                            <div class="category-item">
                                <div class="category-info">
                                    <h3>${category.name}</h3>
                                    <p>${category.channels_count} kanałów</p>
                                    ${category.has_reports ? '<span class="status success">📊 Raporty dostępne</span>' : '<span class="status error">❌ Brak raportów</span>'}
                                </div>
                                <div class="category-actions">
                                    ${category.has_reports ? `
                                        <a href="/trend/rankings/${category.name}" class="btn btn-success">🏆 Ranking Top 10</a>
                    <a href="/trend/modern/${category.name}" class="btn btn-primary">🚀 Nowoczesny Ranking</a>
                                        <button onclick="forceReport('${category.name}')" class="btn btn-warning">🔄 Wymuś Raport</button>
                                        <button onclick="forceRanking('${category.name}')" class="btn btn-info">🔧 Regeneruj Ranking</button>
                                    ` : `
                                        <button onclick="forceReport('${category.name}')" class="btn btn-primary">🔄 Wymuś Raport</button>
                                    `}
                                </div>
                            </div>
                        `;
                    });
                }
                
                document.getElementById('categoriesList').innerHTML = html;
            } catch (error) {
                document.getElementById('categoriesList').innerHTML = `
                    <div class="status error">Błąd podczas ładowania kategorii: ${error.message}</div>
                `;
            }
        }

        // Funkcja do ładowania listy raportów CSV
        async function loadReports() {
            try {
                const response = await fetch(`${API_BASE}/reports/list`);
                const data = await response.json();

                let html = '';
                if (!data.reports || data.reports.length === 0) {
                    html = '<p>Brak dostępnych raportów CSV.</p>';
                } else {
                    data.reports.forEach(report => {
                        // Formatuj rozmiar pliku
                        const sizeKB = (report.size / 1024).toFixed(1);
                        const sizeMB = (report.size / (1024 * 1024)).toFixed(2);
                        const sizeStr = sizeKB < 1024 ? `${sizeKB} KB` : `${sizeMB} MB`;
                        
                        // Formatuj datę
                        const date = new Date(report.created * 1000);
                        const dateStr = date.toLocaleDateString('pl-PL');
                        const timeStr = date.toLocaleTimeString('pl-PL', { hour: '2-digit', minute: '2-digit' });
                        
                        // Wyciągnij kategorię z nazwy pliku
                        const category = report.filename.split('_')[1] || 'Nieznana';
                        
                        html += `
                            <div class="report-item">
                                <div class="report-info">
                                    <h4>📄 ${report.filename}</h4>
                                    <p>📅 Utworzony: ${dateStr}, ${timeStr}</p>
                                    <p>🏷️ Kategoria: ${category}</p>
                                    <p>💾 Rozmiar: ${sizeStr}</p>
                                </div>
                                <div class="report-actions">
                                    <a href="/api/v1/reports/download/${report.filename}" class="btn btn-primary">📥 Pobierz</a>
                                </div>
                            </div>
                        `;
                    });
                }
                document.getElementById('reportsList').innerHTML = html;
            } catch (error) {
                document.getElementById('reportsList').innerHTML = `
                    <div class="status error">Błąd podczas ładowania raportów: ${error.message}</div>
                `;
            }
        }
        
        // Inicjalizacja
        document.addEventListener('DOMContentLoaded', function() {
            loadCategories();
            loadReports(); // Wywołaj funkcję ładowania raportów
        });

        // Funkcja do zwijania/rozwijania sekcji raportów
        function toggleReportsSection() {
            const reportsSection = document.getElementById('reportsSection');
            const toggleButton = event.target;
            
            if (reportsSection.classList.contains('collapsed')) {
                reportsSection.classList.remove('collapsed');
                toggleButton.textContent = '▼';
            } else {
                reportsSection.classList.add('collapsed');
                toggleButton.textContent = '▲';
            }
        }
    </script>
    
    <style>
        .categories-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            transition: all 0.3s ease;
        }
        
        .category-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .category-info h3 {
            margin: 0 0 8px 0;
            color: #333;
            font-size: 1.2em;
        }
        
        .category-info p {
            margin: 0 0 8px 0;
            color: #666;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: 500;
        }
        
        .status-badge.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-badge.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .category-actions {
            display: flex;
            gap: 10px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
            text-decoration: none;
            display: inline-block;
            padding: 10px 20px;
            border-radius: 5px;
            transition: background 0.3s ease;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: 500;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .no-actions {
            color: #666;
            font-style: italic;
        }

        .reports-section {
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .reports-section.collapsed {
            max-height: 0;
            padding: 0;
            margin: 0;
        }

        .btn-toggle {
            background: #f0f0f0;
            border: 1px solid #ccc;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.2em;
            transition: background 0.3s ease;
        }

        .btn-toggle:hover {
            background: #e0e0e0;
        }

        .reports-list-section, .categories-section {
            margin-top: 20px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #f9f9f9;
        }

        .reports-list-section h3, .categories-section h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #333;
        }

        .reports-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .report-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 6px;
            background: #fff;
            transition: all 0.2s ease;
        }

        .report-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transform: translateY(-1px);
        }

        .report-info h4 {
            margin: 0 0 5px 0;
            color: #444;
            font-size: 1.1em;
        }

        .report-info p {
            margin: 0 0 5px 0;
            color: #666;
            font-size: 0.9em;
        }

        .report-actions {
            display: flex;
            gap: 10px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .btn-refresh {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background 0.3s ease;
        }

        .btn-refresh:hover {
            background: #138496;
        }
    </style>
</body>
</html>
