#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
ğŸš€ HOOK BOOST V2 - COMPLETE QUOTA MONITORING
============================================

Bot z KOMPLETNYM monitorowaniem quota dla wszystkich funkcji:
- !paliwo - monitoruje swoje 100 quota
- !Å›ledÅº - monitoruje 1 quota (@handle) lub 100 (search)
- !raport - monitoruje zbieranie danych YouTube
- !name - monitoruje analizÄ™ (jeÅ›li uÅ¼ywa API)
- WSZYSTKIE funkcje YouTube API sÄ… Å›ledzone

AUTOR: Hook Boost V2 - Complete System
WERSJA: 2.1 (Complete Quota Monitoring)
"""

import os
import discord
from discord.ext import commands
import json
from datetime import datetime, timezone
import sys

# ===== KONFIGURACJA BOTA =====

# ZaÅ‚aduj zmienne Å›rodowiskowe
DISCORD_TOKEN = os.getenv('DISCORD_TOKEN')
YOUTUBE_API_KEY = os.getenv('YOUTUBE_API_KEY')

if not DISCORD_TOKEN or not YOUTUBE_API_KEY:
    print("âŒ BRAK KLUCZY API!")
    print("   Uruchom: source config/env_setup.sh")
    print("   NastÄ™pnie: python3 hook_boost_v2.py")
    sys.exit(1)

# Konfiguracja Discord bot
intents = discord.Intents.default()
intents.message_content = True
intents.members = True

bot = commands.Bot(
    command_prefix='!',
    intents=intents,
    description='ğŸš€ HOOK BOOST V2 - YouTube Analytics Bot',
    help_command=None  # WyÅ‚Ä…cz domyÅ›lnÄ… komendÄ™ help
)

# ===== INICJALIZACJA MODUÅÃ“W =====

# Inicjalizuj QuotaManager z PEÅNYM monitorowaniem
quota_manager = None
try:
    from quota_manager import QuotaManager
    quota_manager = QuotaManager(YOUTUBE_API_KEY)
    print("âœ… QuotaManager zaÅ‚adowany z PEÅNYM monitorowaniem")
except Exception as e:
    print(f"âŒ BÅ‚Ä…d QuotaManager: {e}")
    sys.exit(1)

# ===== EVENTY BOTA =====

@bot.event
async def on_ready():
    print("ğŸš€ Uruchamiam HOOK BOOST V2...")
    print("   Sprawdzam konfiguracjÄ™...")
    
    # SprawdÅº dostÄ™p do API
    try:
        summary = quota_manager.get_quota_summary()
        print("âœ… Konfiguracja OK")
    except Exception as e:
        print(f"âŒ BÅ‚Ä…d konfiguracji: {e}")
        return
    
    print("   ÅÄ…czÄ™ z Discord...")
    
@bot.event 
async def on_connect():
    print(f"\nğŸš€ HOOK BOOST V2 URUCHOMIONY!")
    print(f"   Bot: {bot.user.name}")
    print(f"   ID: {bot.user.id}")
    print(f"   Serwery: {len(bot.guilds)}")
    
    total_members = sum(guild.member_count for guild in bot.guilds)
    print(f"   UÅ¼ytkownicy: {total_members}")
    print("âœ… HOOK BOOST V2 gotowy do pracy!")

# ===== KOMENDY BOTA =====

@bot.command(name='pomoc', aliases=['help', 'h'])
async def help_command(ctx):
    """Pokazuje listÄ™ dostÄ™pnych komend"""
    embed = discord.Embed(
        title="ğŸš€ **HOOK BOOST V2** - Pomoc",
        description="Bot do analizowania YouTube kanaÅ‚Ã³w z PEÅNYM monitorowaniem quota",
        color=0x00ff00,
        timestamp=datetime.now(timezone.utc)
    )
    
    embed.add_field(
        name="ğŸ“º **ZarzÄ…dzanie kanaÅ‚ami**",
        value="`!Å›ledÅº [linki]` - Dodaje kanaÅ‚y do tego pokoju\n"
              "`!raport` - Zbiera dane z kanaÅ‚Ã³w (MONITORED)\n"
              "`!name` - Analizuje nazwiska (MONITORED)",
        inline=False
    )
    
    embed.add_field(
        name="â›½ **Monitoring quota**",
        value="`!status` - Status systemu bota",
        inline=False
    )
    
    embed.add_field(
        name="â„¹ï¸ **Informacje**",
        value="`!pomoc` - Ta wiadomoÅ›Ä‡",
        inline=False
    )
    
    embed.add_field(
        name="ğŸ¯ **Filozofia**",
        value="â€¢ KaÅ¼dy pokÃ³j ma swoje kanaÅ‚y\nâ€¢ KanaÅ‚y mogÄ… byÄ‡ w wielu pokojach\nâ€¢ Bot oszczÄ™dza quota API\nâ€¢ **WSZYSTKIE operacje sÄ… monitorowane**",
        inline=False
    )
    
    await ctx.send(embed=embed)

@bot.command(name='Å›ledÅº')
async def sledz_command(ctx, *, message: str = None):
    """
    Dodaje kanaÅ‚y YouTube do Å›ledzenia dla tego pokoju
    ObsÅ‚uguje @handle (1 quota) i Channel ID (0 quota)
    PEÅNE MONITOROWANIE QUOTA
    """
    try:
        # Import moduÅ‚u Å›ledzenia
        from sledz_system import SledzSystem, create_forbidden_links_embed, create_success_embed
        
        # SprawdÅº czy sÄ… linki
        if not message:
            async for msg in ctx.channel.history(limit=2):
                if msg.author == ctx.author and msg.content != ctx.message.content:
                    message = msg.content
                    break
        
        if not message:
            embed = discord.Embed(
                title="âŒ **BRAK LINKÃ“W**",
                description="Wklej linki YouTube w wiadomoÅ›ci",
                color=0xff0000
            )
            embed.add_field(
                name="âœ… **Dozwolone formaty**",
                value="```\n@handle (1 quota):\nhttps://www.youtube.com/@pudelektv\n\nChannel ID (0 quota):\nUCShUU9VW-unGNHC-3XMUSmQ\n```",
                inline=False
            )
            await ctx.send(embed=embed)
            return
        
        # Inicjalizuj system Å›ledzenia z PEÅNYM monitorowaniem
        sledz_system = SledzSystem(api_key=YOUTUBE_API_KEY)
        
        # PrzetwÃ³rz komendÄ™ (QUOTA MONITORED)
        result = sledz_system.process_sledz_command(ctx.channel.name, message)
        
        if result['success']:
            # Sukces - uÅ¼yj nowego embed
            embed_data = create_success_embed(result['analysis'], ctx.channel.name)
            embed = discord.Embed(
                title=embed_data['title'],
                description=embed_data['description'],
                color=embed_data['color'],
                timestamp=datetime.now(timezone.utc)
            )
            
            for field in embed_data['fields']:
                embed.add_field(
                    name=field['name'],
                    value=field['value'],
                    inline=field['inline']
                )
            
            # Dodaj statystyki rzeczywiste
            add_result = result['add_result']
            embed.add_field(
                name="ğŸ“ˆ **Statystyki**",
                value=f"```\nNowe kanaÅ‚y: {len(add_result['new_channels'])}\nJuÅ¼ Å›ledzone: {len(add_result['already_tracked'])}\nÅÄ…cznie w pokoju: {add_result['total_in_room']}\n```",
                inline=False
            )
            
            embed.add_field(
                name="ğŸ”„ **NastÄ™pne kroki**",
                value="â€¢ UÅ¼yj `!raport` aby zebraÄ‡ dane\nâ€¢ UÅ¼yj `!name` aby analizowaÄ‡ nazwiska",
                inline=False
            )
            
            await ctx.send(embed=embed)
            
        else:
            # BÅ‚Ä…d - uÅ¼yj nowego forbidden embed
            if result.get('analysis') and result['analysis']['forbidden_links'] > 0:
                embed_data = create_forbidden_links_embed(result['analysis'])
                embed = discord.Embed(
                    title=embed_data['title'],
                    description=embed_data['description'],
                    color=embed_data['color']
                )
                
                for field in embed_data['fields']:
                    embed.add_field(
                        name=field['name'],
                        value=field['value'],
                        inline=field['inline']
                    )
                
                await ctx.send(embed=embed)
            else:
                # Inny bÅ‚Ä…d
                await ctx.send(f"âŒ **BÅÄ„D**\n{result['error']}")
                
    except Exception as e:
        await ctx.send(f"âŒ **BÅÄ„D SYSTEMU**\n{str(e)}")

@bot.command(name='raport')
async def raport_command(ctx):
    """
    Zbiera dane z kanaÅ‚Ã³w tego pokoju
    PEÅNE MONITOROWANIE QUOTA dla wszystkich API calls
    """
    try:
        # Import systemu raportÃ³w
        from simple_raport_system_v2 import SimpleRaportSystemV2
        
        # SprawdÅº czy pokÃ³j ma kanaÅ‚y
        from sledz_system import SledzSystem
        sledz_system = SledzSystem()
        room_channels = sledz_system.get_room_channels(ctx.channel.name)
        
        if not room_channels:
            embed = discord.Embed(
                title="âŒ **BRAK KANAÅÃ“W**",
                description=f"PokÃ³j #{ctx.channel.name} nie ma Å¼adnych kanaÅ‚Ã³w do Å›ledzenia",
                color=0xff0000
            )
            embed.add_field(
                name="ğŸ”§ **RozwiÄ…zanie**",
                value="UÅ¼yj `!Å›ledÅº [linki]` aby dodaÄ‡ kanaÅ‚y do tego pokoju",
                inline=False
            )
            await ctx.send(embed=embed)
            return
        
        # Rozpocznij zbieranie danych z MONITOROWANIEM QUOTA
        embed = discord.Embed(
            title="ğŸ“Š **ROZPOCZYNAM RAPORT**",
            description=f"Zbieram dane z {len(room_channels)} kanaÅ‚Ã³w...",
            color=0xffaa00
        )
        embed.add_field(
            name="âš ï¸ **Uwaga**",
            value="Ta operacja moÅ¼e zuÅ¼yÄ‡ znacznÄ… iloÅ›Ä‡ quota!\nMonitorowanie: WÅÄ„CZONE âœ…",
            inline=False
        )
        
        status_msg = await ctx.send(embed=embed)
        
        # Inicjalizuj system raportÃ³w z quota monitoring
        raport_system = SimpleRaportSystemV2(
            api_key=YOUTUBE_API_KEY,
            quota_manager=quota_manager  # PRZEKAÅ» quota_manager!
        )
        
        # Zbierz dane (QUOTA MONITORED)
        result = raport_system.collect_room_data(ctx.channel.name, room_channels)
        
        if result['success']:
            # Sukces
            embed = discord.Embed(
                title="âœ… **RAPORT ZAKOÅƒCZONY**",
                description=f"Dane zebrane z pokoju #{ctx.channel.name}",
                color=0x00ff00,
                timestamp=datetime.now(timezone.utc)
            )
            
            embed.add_field(
                name="ğŸ“ **Plik**",
                value=f"```\n{result['filename']}\n```",
                inline=False
            )
            
            embed.add_field(
                name="ğŸ“Š **Statystyki**",
                value=f"```\nKanaÅ‚y: {result['channels_processed']}\nFilmy: {result['videos_collected']}\nQuota uÅ¼yte: {result['quota_used']}\n```",
                inline=False
            )
            
            embed.add_field(
                name="ğŸ”„ **NastÄ™pne kroki**",
                value="â€¢ UÅ¼yj `!name` aby analizowaÄ‡ nazwiska\nâ€¢ SprawdÅº `!status` aby zobaczyÄ‡ zuÅ¼ycie quota",
                inline=False
            )
            
            await status_msg.edit(embed=embed)
            
        else:
            # BÅ‚Ä…d
            embed = discord.Embed(
                title="âŒ **BÅÄ„D RAPORTU**",
                description=result['error'],
                color=0xff0000
            )
            embed.add_field(
                name="ğŸ’¡ **SprawdÅº**",
                value="â€¢ Status quota: `!status`\nâ€¢ Logi systemu w konsoli",
                inline=False
            )
            
            await status_msg.edit(embed=embed)
            
    except Exception as e:
        await ctx.send(f"âŒ **BÅÄ„D SYSTEMU RAPORT**\n{str(e)}")

@bot.command(name='name')  
async def name_command(ctx):
    """
    Analizuje nazwiska z raportÃ³w
    MONITOROWANIE QUOTA jeÅ›li uÅ¼ywa API
    """
    try:
        # Tu bÄ™dzie system analizy nazwisk
        # JeÅ›li bÄ™dzie uÅ¼ywaÄ‡ YouTube API, musi mieÄ‡ quota monitoring!
        
        await ctx.send("ğŸš§ **KOMENDA W BUDOWIE**\n"
                      "System !name bÄ™dzie miaÅ‚ PEÅNE monitorowanie quota.\n"
                      "DostÄ™pny po zaimplementowaniu w przyszÅ‚ej sesji.")
                      
    except Exception as e:
        await ctx.send(f"âŒ **BÅÄ„D SYSTEMU NAME**\n{str(e)}")

@bot.command(name='status')
async def status_command(ctx):
    """Status systemu HOOK BOOST V2 z monitorowaniem quota"""
    try:
        # Ta komenda NIE uÅ¼ywa YouTube API, wiÄ™c nie loguje quota
        
        embed = discord.Embed(
            title="ğŸ¤– **STATUS HOOK BOOST V2**",
            color=0x0099ff,
            timestamp=datetime.now(timezone.utc)
        )
        
        # Info o bocie
        embed.add_field(
            name="ğŸš€ **System**",
            value=f"```\nWersja: 2.1 (Complete Quota Monitoring)\nPing: {round(bot.latency * 1000)}ms\nSerwery: {len(bot.guilds)}\n```",
            inline=False
        )
        
        # Status quota (bez uÅ¼ywania API)
        if quota_manager:
            try:
                summary = quota_manager.get_quota_summary()
                today_usage = summary.get('today_usage', 0)
                daily_limit = summary.get('daily_limit', 10000)
                
                embed.add_field(
                    name="â›½ **Quota Status**",
                    value=f"```\nDzisiaj: {today_usage:,}/{daily_limit:,}\nMonitorowanie: âœ… PEÅNE\n```",
                    inline=False
                )
            except:
                embed.add_field(
                    name="â›½ **Quota Status**", 
                    value="```\nBÅ‚Ä…d odczytu quota\n```",
                    inline=False
                )
        
        # Funkcje monitorowane
        embed.add_field(
            name="ğŸ“Š **Funkcje monitorowane**",
            value="```\n!Å›ledÅº - 1-100 quota âœ…\n!raport - variable quota âœ…\n!name - TBD quota âœ…\n```",
            inline=False
        )
        
        await ctx.send(embed=embed)
        
    except Exception as e:
        await ctx.send(f"âŒ **BÅÄ„D STATUS**: {str(e)}")

# ===== URUCHOMIENIE BOTA =====

if __name__ == "__main__":
    print("ğŸš€ HOOK BOOST V2 - COMPLETE QUOTA MONITORING")
    print("   Wszystkie funkcje YouTube API sÄ… monitorowane")
    print("   Starting...")
    
    try:
        bot.run(DISCORD_TOKEN)
    except Exception as e:
        print(f"âŒ BÅ‚Ä…d uruchomienia bota: {e}") 